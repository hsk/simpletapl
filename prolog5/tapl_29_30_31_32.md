# TAPL29,30,31,32 λω,Fω,Fω<:

## 図29-1.型演算子とカインド付け(λω)

  → ⇒    λ→(図9-1)の拡張

    構文

    t ::=       項：
    x         変数
    λx:T.t    ラムダ抽象
    t t       関数適用
    v ::=       値：
    λx:T.t    ラムダ抽象値
    T ::=       型：
    X         型変数
    λX::K.T   演算子抽象
    T T       演算子適用
    T->T      関数の型
    Γ ::=       文脈：
    ∅         空の文脈
    Γ,x:T     項変数の束縛
    Γ,X::K    型変数の束縛
    K ::=       カインド:
    *         真の型のカインド
    K=>K      演算子のカインド

    評価 t ==> t'

    t1 ==> t1'
    ------------------------------- (E-App1)
    t1 t2 ==> t1' t2

    t2 ==> t2'
    ------------------------------- (E-App2)
    v1 t2 ==> v1 t2'

    (λx:T11.t12) v2 ==> [x->v2]t12  (E-AppAbs)

    カインド付け Γ|- T :: K

    X::K ∈ Γ
    ------------------------------------ (K-TVar)
    Γ |- X ::K

    Γ,X::K1 |- T2::K2
    ------------------------------------ (K-Abs)
    Γ |- λX::K1.T2 :: K1=>K2

    Γ |- T1 :: K11 => K12   Γ |- T2::K11
    ------------------------------------ (K-App)
    Γ |- T1 T2 :: K1=>K12

    Γ |- T1 :: *   Γ |- T2 :: *
    ------------------------------------ (K-Arrow)
    Γ |- T1->T2 :: *

    型等価関係 S ≡ T

    T ≡ T                 (Q-Refl)

    T ≡ S
    --------------------- (Q-Symm)
    S ≡ T

    S ≡ U   U ≡ T
    --------------------- (Q-Trans)
    S ≡ T

    S1 ≡ T1   S2 ≡ T2
    --------------------- (Q-Arrow)
    S1->S2 ≡ T1->T2

    S2 ≡ T2
    --------------------- (Q-Abs)
    λX::K1.S2 ≡ λX::K1.T2

    S1 ≡ T1   S2 ≡ T2
    --------------------- (Q-App)
    S1 S2 ≡ T1 T2

    (λX::K11.T12)T2 ≡ [X|->T2]T12
                        (Q-AppAbs)

    型付け Γ ⊢ t : T

    x : T ∈ Γ
    ------------------------------ (T-Var)
    Γ ⊢ x : T

    Γ ⊢ T1 :: *   Γ,x:T1 ⊢ t2 : T2
    ------------------------------ (T-Abs)
    Γ ⊢ λx:T1.t2 : T1 -> T2

    Γ ⊢ t1 : T11 -> T12
    Γ ⊢ t2 : T11
    ------------------------------ (T-App)
    Γ ⊢ t1 t2 : T12

    Γ ⊢ t : S   S == T   Γ ⊢ T : *
    ------------------------------ (T-Eq)
    Γ ⊢ t : T

## 図30-1.高階多相ラムダ計算(Fω)

  → ∀ ⇒    λω(図29-1)とSystem F(図23-1)の拡張

    構文

    t ::=       項：
      x         変数
      λx:T.t    ラムダ抽象
      t t       関数適用
      λX::K.t   型抽象
      t[T]      型適用

    v ::=       値：
      λx:T.t    ラムダ抽象値
      λX::K.t   型抽象値

    T ::=       型：
      X         型変数
      T->T      関数の型
      ∀X::K.T  全称型
      λX::K.T   演算子抽象
      T T       演算子適用

    Γ ::=       文脈：
      ∅         空の文脈
      Γ,x:T     項変数の束縛
      Γ,X::K    型変数の束縛

    K ::=       カインド:
      *         真の型のカインド
      K=>K      演算子のカインド

## 図30-2.高階存在型

  → ∀ ∃ ⇒    Fω(図30-1)と図24-1の拡張

    新しい構文形式

    T ::= …    型：
    　{∃X::K,T}  存在型

    新しい評価規則 t ==> t’

    let {X,x}=({*T11,v12}as T1) in t2
      ⇒ [X->T11][x->v12]t2              (E-UnpackPack)

    t12 ⇒ t12’
    ------------------------------------ (E-Pack)
    {*T11,t12} as T1 ⇒{*T11,t12’} as T1

    新しいカインド付け規則 Γ ⊢ T :: K

    Γ,X::K1 ⊢ T2 :: *
    ------------------------------------ (K-Some)
    Γ ⊢ {∃X::K1,T2} :: *

    新しい型等価関係の規則 S ≡ T

    S2 ≡ T2
    ------------------------------------ (Q-Some)
    {∃X::K1,S2} ≡ {∃X::K1,T2}

    新しい型付け規則 Γ ⊢ t : T

    Γ ⊢ t2 : [X -> U] T2
    Γ ⊢ {∃X::K1,T2} :: *
    ------------------------------------ (T-Pack)
    Γ ⊢ {*U,t2} as {∃X::K1,T2}

    Γ ⊢ t1 : {∃X::K11,T12}
    Γ,X::K11,x:T12 ⊢ t2 : T2
    ------------------------------------ (T-Unpack)
    Γ ⊢ let {X,x}=t1 in t2 : T2

## 図30-3.型の並行簡約

    並行簡約 S ⇛ T

    T ⇛ T                              (QR-REFL)

    S1 ⇛ T1   S2 ⇛ T2
    ---------------------------------- (QR-Arrow)
    S1 -> S2 ⇛ T1 -> T2

    S2 ⇛ T2
    ---------------------------------- (QR-All)
    ∀X::K1.S2 ⇛ ∀X::K1.S2

    S2 ⇛ T2
    ---------------------------------- (QR-Abs)
    λX::K1.S2 ⇛ λX::K1.T2

    S1 ⇛ T1   S2 ⇛ T2
    ---------------------------------- (QR-App)
    S1 S2 ⇛ T1 T2

    S12 ⇛ T12   S2 ⇛ T2 
    ---------------------------------- (QR-AppAbs)
    (λX::K11.S12) S2 ⇉ [X ↦ T2]T12

## 図31-1.高階有界量化 (Fω<:)

  → ∀ ∃ ⇒    Fω(図30-1)とカーネルF<:(図26-1)の拡張

    構文

    t ::=       項：
      x         変数
      λx:T.t    ラムダ抽象
      t t       関数適用
      λX<:T.t   型抽象
      t[T]      型適用
    v ::=       値：
      λx:T.t    ラムダ抽象値
      λX<:T.t   型抽象値
    T ::=       型：
      X         型変数
      T->T      関数の型
      ∀X<:T.T  全称型
      λX::K.T   演算子抽象
      T T       演算子適用
    Γ ::=       文脈：
      ∅         空の文脈
      Γ,x:T     項変数の束縛
      Γ,X<:T    型変数の束縛
    K ::=       カインド:
      *         真の型のカインド
      K=>K      演算子のカインド

    評価 t ==> t'
    t1 ==> t1'
    -------------------------------  (E-App1)
    t1 t2 ==> t1' t2

    t2 ==> t2'
    -------------------------------  (E-App2)
    v1 t2 ==> v1 t2'

    (λx:T11.t12) v2 ==> [x->v2]t12   (E-AppAbs)

    t1 ==> t1'
    -------------------------------  (E-TApp)
    t1 [T2] ==> t1' [T2]

    (λx<:T11.t12)[T2] ==> [x->T2]t12 (E-AppAbs)

    カインド付け Γ|- T :: K
    Γ |- Top :: * (K-Top)

    X<:T ∈ Γ   Γ |- X :: K
    ------------------------------------ (K-TVar)
    Γ |- X ::K

    Γ,X<:Top[K1] |- T2::K2
    ------------------------------------ (K-Abs)
    Γ |- λX::K1.T2 :: K1=>K2

    Γ |- T1 :: K11 => K12   Γ |- T2::K11
    ------------------------------------ (K-App)
    Γ |- T1 T2 :: K1=>K12

    Γ |- T1 :: *   Γ |- T2 :: *
    ------------------------------------ (K-Arrow)
    Γ |- T1->T2 :: *

    Γ,X<:T1 |- T2 :: *
    ------------------------------------ (K-All)
    Γ |- ∀X<:T1.T2 :: *

    型等価関係 S ≡ T

    T ≡ T                 (Q-Refl)

    T ≡ S
    --------------------- (Q-Symm)
    S ≡ T

    S ≡ U   U ≡ T
    --------------------- (Q-Trans)
    S ≡ T

    S1 ≡ T1   S2 ≡ T2
    --------------------- (Q-Arrow)
    S1->S2 ≡ T1->T2

    S1 ≡ T1   S2 ≡ T2
    --------------------- (Q-All)
    ∀X<:S1.S2 ≡ ∀X<:T1.T2

    S2 ≡ T2
    --------------------- (Q-Abs)
    λX::K1.S2 ≡ λX::K1.T2

    S1 ≡ T1   S2 ≡ T2
    --------------------- (Q-App)
    S1 S2 ≡ T1 T2

    (λX::K11.T12)T2 ≡ [X|->T2]T12
                          (Q-AppAbs)



## 図31-1.高階有界量化 (Fω<:)(2)

    部分型付け S <: T

    Γ ⊢ S <: U　　Γ ⊢ U <: T　　Γ ⊢ U :: K
    --------------------------------- (S-Trans)
    Γ ⊢ S <: T

    Γ ⊢ S :: *
    --------------------------------- (S-Top)
    Γ ⊢ S <: Top

    Γ ⊢ T1 <: S1　　Γ ⊢ S2 <: T2
    --------------------------------- (S-Arrow)
    Γ ⊢ S1 -> S2 <: T1 -> T2

    X <: T ∈ Γ
    --------------------------------- (S-TVar)
    Γ ⊢ X <: T

    Γ ⊢ U1 :: K1   Γ,X<:U1 ⊢ S2 <: T2
    --------------------------------- (S-All)
    Γ ⊢ ∀X<:U1.S2 <: ∀X<:U1.T2

    Γ,X<:Top[K1] ⊢ S2 <: T2
    --------------------------------- (S-Abs)
    Γ ⊢ λX::K1.S2 <: λX::K2.T2

    Γ ⊢ S1 <: T1
    --------------------------------- (S-App)
    Γ ⊢ S1 U <: T1 U

    Γ ⊢ S :: K   Γ ⊢ T :: K   S ≡ T
    --------------------------------- (S-Eq)
    Γ ⊢ S <: T

    型付け Γ ⊢ t : T

    x : T ∈ Γ
    ------------------------------ (T-Var)
    Γ ⊢ x : T

    Γ ⊢ T1 :: *   Γ,x:T1 ⊢ t2 : T2
    ------------------------------ (T-Abs)
    Γ ⊢ λx:T1.t2 : T1 -> T2

    Γ ⊢ t1 : T11 -> T12
    Γ ⊢ t2 : T11
    ------------------------------ (T-App)
    Γ ⊢ t1 t2 : T12

    Γ ⊢ t : S   S == T   Γ ⊢ T : *
    ------------------------------ (T-Eq)
    Γ ⊢ t : T

    Γ,X<:T ⊢ t2 : T2
    -------------------------------------- (T-TAbs)
    Γ ⊢ λX<:T.t2 : ∀X<:T.T2

    Γ ⊢ t1 : ∀X<:T11.T12   Γ ⊢ T2 <: T11
    -------------------------------------- (T-TApp)
    Γ ⊢ t1[T2] : [X -> T2] T12

    Γ ⊢ t : S   Γ ⊢ S <: T   Γ ⊢ T :: *
    -------------------------------------- (T-Sub)
    Γ ⊢ t : T

## 図32-1.多相更新

  → ∀ <: Top {} ←    F<:(図26-1)とレコード(図11-7)に基づく

    新しい構文形式

    t ::= …             項:
      {}                レコード
      t<-l = t          フィールド更新
    T ::= …             型：
    　{ιi li:Ti i∈1..n} レコードの型
    ι ::=
      #                 非変な(更新可能)フィールド
      omitted           共変な(更新不能)フィールド

    新しい評価規則 t ==> t’

    t1 ==> t1’
    ---------------------------------------- (E-Update1)
    t1<-li=t2 ==> t1’<-li=t2

    t2 ==> t2’
    ---------------------------------------- (E-Update2)
    v1<-li=t2 ==> v1<-li=t2’

    {ιj lj=vj j∈1..n}<-li=v
    ==> {ιj lj=vj j∈1..i-1, ιi li=v, ιk lk=vk k∈i+1..n}
                                            (E-UpdateV)

    {ιi li=vi i∈1..n}.lj ==> vj             (E-ProjRcd)

    tj ==> tj’
    -------------------------------------------- (E-Rcd)
    {ιi li=vi i∈1..j-1, ιj lj=tj, ιk lk=tk k∈j+1..n}
    ==> {ιi li=vi i∈1..j-1, ιj lj=tj’, ιk lk=tk k∈j+1..n}


    新しい部分型付け S <: T

    Γ ⊢ {ιi li:Ti i∈1..n+k}<:{ιi li:Ti i∈1..n}
                                              (S-RcdWidth)

    各iに対して Γ ⊢ Si <: Ti
    ιi = # ならば Γ ⊢ Ti <: Si
    ------------------------------------------ (S-RcdDepth)
    Γ ⊢ {ιi li:Ti i∈1..n}<:{ιi li:Ti i∈1..n}

    Γ ⊢ {…#li:Si…}<:{…li:Si…}               (S-RcdVariance)

    新しい型付け規則 Γ ⊢ t : T

    各iに対して Γ ⊢ ti : Ti
    ------------------------------------------ (T-Rcd)
    Γ ⊢ {ιi li=ti i∈1..n}:{ιi li:Ti i∈1..n}

    Γ ⊢ t1 : {ιi li:Ti i∈1..n}
    ------------------------------------------ (T-Proj)
    Γ ⊢ t1.lj : Tj

    Γ ⊢ r : R   Γ ⊢ R <: {#lj:Tj}
    Γ ⊢ t : Tj
    ------------------------------------------ (T-Update)
    Γ ⊢ r<-lj = t : R

