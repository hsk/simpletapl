# TAPL15,16 部分型付け
## 図15-1.部分型付けを持つ単純型付きラムダ計算(λ<:)

  →<: Top   λ→(図9-1)に基づく

    構文

    t ::=       項：
      x         変数
      λx:T.t    ラムダ抽象
      t t       関数適用

    v ::=       値：
      λx:T.t    ラムダ抽象値

    T ::=       型：
      Top       最大の型
      T->T      関数の型

    Γ ::=       文脈：
      ∅         空の文脈
      Γ,x:T     項変数の束縛

    評価 t ==> t’

    t1 ==> t1’
    -------------------------------- (E-App1)
    t1 t2 ==> t1’ t2

    t2 ==> t2’
    -------------------------------- (E-App2)
    v1 t2 ==> v1 t2’

    (λx:T11.t12) v2 ==> [x->v2]t12   (E-AppAbs)

    部分型付け S <: T

    S <: S               (S-Refl)

    S <: U　　U <: T
    -------------------- (S-Trans)
    S <: T

    S <: Top             (S-Top)

    T1 <: S1　　S2 <: T2
    -------------------- (S-Arrow)
    S1 -> S2 <: T1 -> T2

    型付け Γ ⊢ t : T

    x : T ∈ Γ
    ------------------------------------ (T-Var)
    Γ ⊢ x : T

    Γ,x:T1 ⊢ t2 : T2
    ------------------------------------ (T-Abs)
    Γ ⊢ λx:T1.t2 : T1 -> T2

    Γ ⊢ t1 : T11 -> T12　　Γ ⊢ t2 : T11
    ------------------------------------ (T-App)
    Γ ⊢ t1 t2 : T12

    Γ ⊢ t : S　　S <: T
    ------------------------------------ (T-Sub)
    Γ ⊢ t : T

## 図15-3.レコードと部分型付け

  →{} <:   λ<:(図15-1)と単調なレコードの規則(図15-2)の拡張

    新い構文形式

    t ::= …          項：
    　{li=ti i∈1..n} レコード
    　tl             射影

    v .::= …      値：
    　{li=vi i∈1..n} レコードの値

    T ::= …      型：
    　{li:T i∈1..n} レコードの型

    新しい部分型付け規則 S <: T

    {li:Ti i∈1..n+k} <: {li:Ti i∈1..n}   (S-RcdWidth)

    各iに対して Si <: Ti
    ------------------------------------- (S-RcdDepth)
    {li:Si i∈1..n} <: {li:Ti i∈1..n}


    {kj:Sj j∈1..n} は {li:Ti i∈1..n} の並べ替えである
    ------------------------------------- (S-RcdPerm)
    {kj:Sj j∈1..n} <: {li:Ti i∈1..n}

    新しい評価規則 t ==> t’

    {li=vi i∈1..n}.lj ==> vj            (E-ProjRcd)

    t1 ==> t1'
    —————————————————— (E-Proj)
    t1.l ==> t1'.l

    tj ==> tj'
    —————————————————— (E-Rcd)
    {li=vi i∈1..j-1, lj=tj, lk=tk k∈j+1..n}
    ==> {li=vi i∈1..j-1, lj=tj', lk=tk k∈j+1..n}

    新しい型付け規則 Γ ⊢ t : T

    各iに対して Γ ⊢ ti : Ti
    —————————————————— (T-Rcd)
    Γ ⊢ {li=ti i∈1..n} : {li:Ti i∈1..n} 

    Γ ⊢ t1 : {li:Ti i∈1..n} 
    —————————————————— (T-Proj)
    Γ ⊢ t1.lj : Tj

## 図15-4.Bottom型

  → <: Bot   λ<:(図15-1)の拡張

    新しい構文形式

    T ::= …      型：
    　Bot         最小の型

    新しい部分型付け規則 S <: T

    Bot <: T   (S-Bot)

## 図15-5.バリアントと部分型付け

  → <> <:   λ<:(図15-1)と単調なバリアントの規則(図11-11)の拡張


    新しい構文形式

    t ::= …              項：
    　<l=t> (as はなし)   タグ付け

    新しい型付け規則 Γ ⊢ t : T

    Γ ⊢ t1 : T1
    —————————————— (T-Variant)
    Γ ⊢ <l1=t1> : <l1:T1>

    新しい部分型付け規則 S <: T

    <li:Ti i∈1..n> <: <li:Ti i∈1..n+k>   (S-VariantWidth)

    各iに対して Si <: Ti
    ——————————————————— (S-VariantDepth)
    <li:Si i∈1..n> <: <li:Ti i∈1..n>


    <kj:Sj j∈1..n> は <li:Ti i∈1..n> の並べ替えである
    ——————————————————— (S-VariantPerm)
    <kj:Sj j∈1..n> <: <li:Ti i∈1..n>

## 図16-1.レコードのある部分型関係(簡潔な版)

  → {} <:   図15-1と図15-3の拡張

    S <: S               (S-Refl)

    S <: U　　U <: T
    —————————— (S-Trans)
    S <: T

    S <: Top             (S-Top)

    T1 <: S1　　S2 <: T2
    —————————— (S-Arrow)
    S1 -> S2 <: T1 -> T2

    {li i∈1..n} ⊆ {kj j∈1..m}
    kj = li ならば Sj <: Ti
    ——————————————————— (S-Rcd)
    {kj:Sj j∈1..m} <: {li:Ti i∈1..n}

## 図16-2.アルゴリズム的部分型付け

  → {} <:

    アルゴリズム的部分型付け |-> S <: T

    |-> S <: Top                           (S-Top)

    |-> T1 <: S1　　|-> S2 <: T2
    ——————————————————— (S-Arrow)
    |-> S1 -> S2 <: T1 -> T2

    {li i∈1..n} ⊆ {kj j∈1..m}
    kj = li ならば |-> Sj <: Ti
    ——————————————————— (S-Rcd)
    |-> {kj:Sj j∈1..m} <: {li:Ti i∈1..n}

## 図16-3.アルゴリズム的型付け

  → {} <:

    アルゴリズム的型付け Γ ↦ t : T

    x : T ∈ Γ
    ————————————————————— (TA-Var)
    Γ ↦ x : T

    Γ,x:T1 ↦ t2 : T2
    ————————————————————— (TA-Abs)
    Γ ↦ λx:T1.t2 : T1 -> T2

    Γ ↦ t1 : T1　　T1 = T11 -> T12
    Γ ↦ t2 : T2　　↦ T2 <: T11
    ————————————————————— (TA-App)
    Γ ↦ t1 t2 : T12

    各iに対してΓ ↦ ti : Ti
    ————————————————————— (TA-Rcd)
    Γ ↦ {l1=t1…ln=tn} : {l1:T1…ln:Tn}

    Γ ↦ t1 : R1　　R1 = {l1:T1…ln:Tn}
    ————————————————————— (T-Proj)
    Γ ↦ t1.li : Ti

## 図16-?.T-If,TA-If, SA-Bot,AppBot,ProjBot

    型付け Γ ↦ t : T

    Γ ⊢ t1 : Bool   Γ ⊢ t2 : T   Γ ⊢ t3 : T
    ---------------------------------------- (T-If)
    Γ ⊢ if t1 then t2 else t3 : T


    Γ ⊢ t1 : T1   T1 = Bool
    Γ ⊢ t2 : T2   Γ ⊢ t3 : T3   T2 ∨ T3=T
    ---------------------------------------- (TA-If)
    Γ ⊢ if t1 then t2 else t3 : T

    ↦ Bot <: T (SA-Bot)

    Γ ↦ t1 : T1　　T1 = Bot   Γ ↦ t2 : T2
    ---------------------------------------- (TA-AppBot)
    Γ ↦ t1 t2 : Bot

    Γ ↦ t1 : R1　　R1 = Bot
    ---------------------------------------- (TA-ProjBot)
    Γ ↦ t1.li : Bot


